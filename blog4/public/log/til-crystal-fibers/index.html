<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TIL: Crystal Fibers for Concurrency | DevLog</title>
  <meta name="description" content="How to use Crystal's Fiber and Channel for lightweight concurrency">
  <meta property="og:title" content="TIL: Crystal Fibers for Concurrency">
<meta property="og:type" content="article">
<meta property="og:url" content="http://localhost:3000/log/til-crystal-fibers/">
<meta property="og:description" content="How to use Crystal's Fiber and Channel for lightweight concurrency">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="TIL: Crystal Fibers for Concurrency">
<meta name="twitter:description" content="How to use Crystal's Fiber and Channel for lightweight concurrency">

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#059669',
            'primary-light': '#34d399',
            surface: '#f0fdf4',
            'surface-alt': '#e6f7ed',
            border: '#c6e9d3',
            muted: '#4a6a4a',
          },
          fontFamily: {
            mono: ['ui-monospace', '"SFMono-Regular"', 'Consolas', '"Liberation Mono"', 'Menlo', 'monospace'],
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      },
    }
  </script>

  <style type="text/tailwindcss">
    /* Prose: markdown rendered content */
    .prose h1, .prose h2, .prose h3, .prose h4 {
      @apply font-mono font-bold leading-tight;
    }
    .prose h1 { @apply text-2xl mb-4 mt-0; }
    .prose h2 { @apply text-xl mt-8 mb-3; }
    .prose h3 { @apply text-base mt-6 mb-2; }
    .prose p { @apply mb-4 leading-relaxed; }
    .prose a { @apply text-primary hover:underline; }
    .prose code {
      @apply font-mono text-[0.88em] bg-surface-alt px-1.5 py-0.5 rounded;
    }
    .prose pre {
      @apply bg-surface-alt border-l-[3px] border-l-primary px-5 py-4 overflow-x-auto my-4 rounded-r leading-relaxed;
    }
    .prose pre code { @apply bg-transparent p-0; }
    .prose blockquote {
      @apply border-l-[3px] border-dashed border-l-primary py-2 px-4 my-4 text-muted bg-surface-alt rounded-r;
    }
    .prose blockquote p:last-child { @apply mb-0; }
    .prose ul, .prose ol { @apply mb-4 ml-6; }
    .prose li { @apply my-1; }
    .prose img { @apply max-w-full rounded; }
    .prose table { @apply w-full border-collapse my-6; }
    .prose th, .prose td { @apply px-3 py-2 border border-border text-left text-sm; }
    .prose thead { @apply bg-surface-alt; }

    /* Timeline */
    .timeline-item {
      @apply flex gap-5 py-5 border-l-2 border-border ml-2 pl-6 relative;
    }
    .timeline-item::before {
      content: "";
      @apply absolute -left-[5px] top-7 w-2 h-2 bg-primary rounded-full;
    }

    /* Pagination */
    nav.pagination { @apply my-6; }
    nav.pagination .pagination-list {
      @apply list-none p-0 m-0 flex gap-2 flex-wrap items-center justify-center;
    }
    nav.pagination a {
      @apply inline-block px-3 py-1.5 rounded border border-border text-sm no-underline text-muted
             hover:text-primary hover:border-primary transition-colors;
    }
    .pagination-current span {
      @apply inline-block px-3 py-1.5 rounded border border-primary bg-primary text-white text-sm font-medium;
    }
    .pagination-disabled span {
      @apply inline-block px-3 py-1.5 rounded border border-border text-muted opacity-50 text-sm;
    }

    /* Section list (taxonomy content) */
    ul.section-list { @apply list-none p-0 my-6 space-y-2; }
    ul.section-list li {
      @apply p-3 bg-surface-alt rounded border border-border;
    }
    ul.section-list li a { @apply font-medium text-primary; }

    /* Alert shortcode */
    .alert {
      @apply py-3 px-4 border border-border border-l-4 border-l-primary bg-surface-alt rounded-r my-4 text-sm;
    }

    /* Version badge */
    .version-badge {
      @apply inline-block font-mono text-xs font-semibold px-3 py-0.5 bg-primary text-white rounded-full;
    }
  </style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai-sublime.min.css">
  
</head>
<body class="font-sans text-gray-900 bg-surface leading-relaxed">
  <header class="border-b-2 border-primary bg-surface py-4">
    <div class="max-w-3xl mx-auto px-6 flex items-center justify-between">
      <a href="http://localhost:3000/" class="font-mono text-xl font-bold text-gray-900 no-underline hover:text-primary transition-colors"><span class="text-primary">&gt;_</span> DevLog</a>
      <nav class="flex gap-6">
        <a href="http://localhost:3000/log/" class="font-mono text-sm text-muted no-underline hover:text-primary transition-colors">Log</a>
        <a href="http://localhost:3000/tags/" class="font-mono text-sm text-muted no-underline hover:text-primary transition-colors">Tags</a>
        <a href="http://localhost:3000/about/" class="font-mono text-sm text-muted no-underline hover:text-primary transition-colors">About</a>
      </nav>
    </div>
  </header>
  <main class="max-w-3xl mx-auto px-6 py-8">
    <h1 class="font-mono text-2xl font-bold mb-4">TIL: Crystal Fibers for Concurrency</h1>
    <div class="prose"><p>Today I learned how Crystal handles concurrency with <strong>Fibers</strong> — lightweight green threads managed by the runtime.</p>
<h2 id="the-basics">The basics</h2>
<p>Crystal uses <code>spawn</code> to create a fiber and <code>Channel</code> to communicate between them:</p>
<pre><code class="language-crystal hljs">ch = Channel(Int32).new

spawn do
  result = expensive_computation()
  ch.send(result)
end

# Do other work while fiber runs
value = ch.receive
puts &quot;Got: #{value}&quot;
</code></pre>
<h2 id="key-takeaways">Key takeaways</h2>
<ul>
<li>Fibers are <strong>cooperative</strong>, not preemptive — they yield at IO boundaries</li>
<li>A <code>Channel</code> is typed and can be buffered or unbuffered</li>
<li>Use <code>select</code> for waiting on multiple channels</li>
</ul>
<blockquote>
<p>Fibers are incredibly cheap to create. Spawning 100k fibers is totally fine.</p>
</blockquote>
<h2 id="gotchas">Gotchas</h2>
<p>Be careful with shared mutable state. Crystal doesn't have a borrow checker — it's up to you to avoid data races:</p>
<pre><code class="language-crystal hljs"># BAD: shared mutable array
results = [] of Int32
10.times do |i|
  spawn { results &lt;&lt; i }
end
sleep 0.1

# GOOD: use a channel instead
ch = Channel(Int32).new
10.times do |i|
  spawn { ch.send(i) }
end
10.times { results &lt;&lt; ch.receive }
</code></pre>
<p>{{&lt; alert type=&quot;tip&quot; message=&quot;Always prefer channels over shared state for inter-fiber communication.&quot; &gt;}}</p>
</div>
  </main>
  <footer class="max-w-3xl mx-auto mt-12 px-6 py-6 border-t border-border text-center text-xs text-muted font-mono">
    <p>Powered by <a href="https://github.com/aspect-build/hwaro" class="text-primary hover:underline">Hwaro</a> &middot; &gt;_ DevLog</p>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
  
</body>
</html>