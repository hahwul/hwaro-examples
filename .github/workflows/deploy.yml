name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest

      - name: Install Hwaro
        run: |
          git clone https://github.com/hahwul/hwaro /tmp/hwaro
          cd /tmp/hwaro
          shards install
          shards build --release
          sudo mv bin/hwaro /usr/local/bin/

      - name: Build all sites
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          BASE_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/${REPO_NAME}"
          OUTPUT_DIR="${GITHUB_WORKSPACE}/_site"
          mkdir -p "${OUTPUT_DIR}"

          for dir in */; do
            dir_name="${dir%/}"
            if [ -f "${dir_name}/config.toml" ]; then
              echo "Building ${dir_name}..."
              hwaro build \
                -i "${dir_name}" \
                -o "${OUTPUT_DIR}/${dir_name}" \
                --base-url "${BASE_URL}/${dir_name}"
              echo "Done: ${dir_name}"
            fi
          done

      - name: Generate index page
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          BASE_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/${REPO_NAME}"
          OUTPUT_DIR="${GITHUB_WORKSPACE}/_site"

          SITE_LINKS=""
          for dir in */; do
            dir_name="${dir%/}"
            if [ -f "${dir_name}/config.toml" ]; then
              TITLE=$(grep '^title' "${dir_name}/config.toml" | head -1 | sed 's/title *= *"//;s/"//')
              DESCRIPTION=$(grep '^description' "${dir_name}/config.toml" | head -1 | sed 's/description *= *"//;s/"//')
              SITE_LINKS="${SITE_LINKS}<a href=\"${BASE_URL}/${dir_name}/\" class=\"card\"><strong>${dir_name}</strong><span class=\"title\">${TITLE}</span><span class=\"desc\">${DESCRIPTION}</span></a>"
            fi
          done
          echo "examples.hwaro.hahwul.com" > "${OUTPUT_DIR}/CNAME"
          cat > "${OUTPUT_DIR}/index.html" << HTMLEOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Hwaro Examples</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; padding: 3rem 1.5rem; }
              h1 { text-align: center; font-size: 2rem; margin-bottom: 0.5rem; color: #fff; }
              p.sub { text-align: center; color: #888; margin-bottom: 2.5rem; }
              .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; max-width: 960px; margin: 0 auto; }
              .card { display: flex; flex-direction: column; gap: 0.25rem; padding: 1.25rem; border: 1px solid #222; border-radius: 8px; text-decoration: none; color: #e0e0e0; transition: border-color 0.2s, background 0.2s; }
              .card:hover { border-color: #555; background: #111; }
              .card strong { font-size: 1.1rem; color: #fff; }
              .card .title { font-size: 0.85rem; color: #aaa; }
              .card .desc { font-size: 0.8rem; color: #666; margin-top: 0.25rem; }
            </style>
          </head>
          <body>
            <h1>Hwaro Examples</h1>
            <p class="sub">A collection of example sites built with Hwaro</p>
            <p><svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 200 200"
                width="400px"
                height="100%"
                style="display: block; margin: 0 auto"
            >
                <defs>
                    <filter
                        id="fire-wobble"
                        x="-20%"
                        y="-20%"
                        width="140%"
                        height="140%"
                    >
                        <feTurbulence
                            type="fractalNoise"
                            baseFrequency="0.04 0.08"
                            numOctaves="2"
                            result="noise"
                        >
                            <animate
                                attributeName="baseFrequency"
                                values="0.04 0.08; 0.05 0.12; 0.04 0.08"
                                dur="2.5s"
                                repeatCount="indefinite"
                            />
                        </feTurbulence>
                        <feDisplacementMap
                            in="SourceGraphic"
                            in2="noise"
                            scale="2.5"
                            xChannelSelector="R"
                            yChannelSelector="G"
                        />
                    </filter>
                    <style>
                        /* 붉은 영역이 숨을 쉬듯 커졌다 작아지는 펄스 애니메이션 */
                        .fire-pulse {
                            transform-origin: center 144px; /* 화살창 바닥을 기준으로 스케일링 */
                            animation: pulse 1.5s infinite alternate ease-in-out;
                        }
                        @keyframes pulse {
                            0% {
                                transform: scaleY(1);
                                opacity: 0.92;
                            }
                            100% {
                                transform: scaleY(1.03);
                                opacity: 1;
                            }
                        }

                        /* 불티(Sparks) 애니메이션 */
                        .spark {
                            animation-timing-function: ease-in;
                            animation-iteration-count: infinite;
                        }
                        .spark-1 {
                            animation-name: flyUp1;
                            animation-duration: 2s;
                        }
                        .spark-2 {
                            animation-name: flyUp2;
                            animation-duration: 2.5s;
                            animation-delay: 0.5s;
                        }
                        .spark-3 {
                            animation-name: flyUp3;
                            animation-duration: 1.8s;
                            animation-delay: 1.2s;
                        }

                        @keyframes flyUp1 {
                            0% {
                                transform: translateY(0);
                                opacity: 0;
                            }
                            50% {
                                opacity: 0.8;
                            }
                            100% {
                                transform: translateY(-40px);
                                opacity: 0;
                            }
                        }
                        @keyframes flyUp2 {
                            0% {
                                transform: translateY(0);
                                opacity: 0;
                            }
                            50% {
                                opacity: 1;
                            }
                            100% {
                                transform: translateY(-50px);
                                opacity: 0;
                            }
                        }
                        @keyframes flyUp3 {
                            0% {
                                transform: translateY(0);
                                opacity: 0;
                            }
                            50% {
                                opacity: 0.9;
                            }
                            100% {
                                transform: translateY(-45px);
                                opacity: 0;
                            }
                        }
                    </style>
                </defs>

                <rect x="48" y="34" width="104" height="10" fill="#7A7B7E" />
                <path
                    d="M 28 150 L 28 54 L 172 54 L 172 150 L 154 150 L 154 72 L 46 72 L 46 150 Z"
                    fill="#7A7B7E"
                />
                <rect x="28" y="160" width="144" height="10" fill="#7A7B7E" />

                <g class="fire-pulse" filter="url(#fire-wobble)">
                    <rect
                        x="50"
                        y="76"
                        width="100"
                        height="68"
                        fill="#ED1C24"
                    />
                    <path
                        d="M 50 76 L 150 76 L 150 84 L 58 84 L 58 144 L 50 144 Z"
                        fill="#BE1622"
                    />
                </g>

                <g>
                    <circle
                        cx="70"
                        cy="130"
                        r="1.5"
                        fill="#FFD54F"
                        class="spark spark-1"
                        opacity="0"
                    />
                    <circle
                        cx="100"
                        cy="135"
                        r="2"
                        fill="#FFA000"
                        class="spark spark-2"
                        opacity="0"
                    />
                    <circle
                        cx="130"
                        cy="125"
                        r="1.5"
                        fill="#FFD54F"
                        class="spark spark-3"
                        opacity="0"
                    />
                </g>
                <rect x="50" y="124" width="100" height="8" fill="#FFFFFF" />
                <path
                    d="M50 124 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12"
                    fill="#FFFFFF"
                />
                <path
                    d="M56 132 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12 h6 v12 h5.75 v-12"
                    fill="#FFFFFF"
                />
            </svg></p>
            <div class="grid">${SITE_LINKS}</div>
          </body>
          </html>
          HTMLEOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
